openapi: 3.1.0
info:
  title: Y-Sweet Server API
  version: 1.0.0
  description: |
    Y-Sweet is a real-time collaboration server for Yjs documents.

    This API provides endpoints for:
    - Creating and managing Yjs documents
    - Generating authentication tokens for document access
    - Real-time WebSocket synchronization
    - Asset management (images/videos) with presigned URLs
    - Document operations (copy, delete)

    **Fork Information**: This is a fork of jamsocket/y-sweet with custom extensions
    for presigned URLs, document management, and Datadog APM integration.

    ## API Audience Classification

    This API is organized by intended audience:

    ### üîê Admin API (Server Token Required)
    Administrative operations that should only be called from your backend server.
    These endpoints require a server-level authentication token.

    **Use cases:**
    - Creating new documents
    - Generating client authentication tokens
    - Deleting or copying documents
    - Store validation

    ### üåê Client API (Doc Token or Browser)
    Operations intended to be called directly from browser clients.
    These endpoints require a document-level authentication token.

    **Use cases:**
    - Reading and writing document content
    - Real-time WebSocket synchronization
    - Uploading and downloading assets

    ### üîì Public API (No Authentication)
    Public endpoints that don't require authentication.

    **Use cases:**
    - Health checks and monitoring
  contact:
    name: Y-Sweet Support
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.example.com
    description: Production server

tags:
  # Audience-based tags
  - name: Admin API
    description: üîê Administrative operations (requires Server Token) - call from your backend only
    externalDocs:
      description: Authentication Guide
      url: https://github.com/jamsocket/y-sweet
  - name: Client API
    description: üåê Client operations (requires Doc Token) - safe to call directly from browser
  - name: Public API
    description: üîì Public operations (no authentication required)

  # Functional tags
  - name: Health
    description: Health check and readiness endpoints
  - name: Documents
    description: Document creation, authentication, and management
  - name: Assets
    description: Asset upload and download with presigned URLs
  - name: WebSocket
    description: Real-time document synchronization via WebSocket
  - name: Single Document Mode
    description: Endpoints for single-document mode (special use case)

components:
  securitySchemes:
    ServerToken:
      type: http
      scheme: bearer
      description: |
        Server-level authentication token for administrative operations.
        Required for: document creation, store checks, document deletion, document copying.

    DocToken:
      type: http
      scheme: bearer
      description: |
        Document-level authentication token for document access.
        Generated via `/doc/:doc_id/auth` endpoint.
        Required for: reading/writing documents, accessing assets.

        Authorization levels:
        - `full`: Read and write access
        - `read-only`: Read-only access

  schemas:
    ReadyResponse:
      type: object
      required:
        - ok
      properties:
        ok:
          type: boolean
          example: true
      description: Health check response

    CheckStoreResponse:
      type: object
      required:
        - ok
      properties:
        ok:
          type: boolean
          example: true
        error:
          type: string
          example: "No store set."
      description: Store validation response

    DocCreationRequest:
      type: object
      properties:
        docId:
          type: string
          description: Optional custom document ID. If not provided, a random nanoid will be generated.
          example: "my-custom-doc-id"

    NewDocResponse:
      type: object
      required:
        - docId
      properties:
        docId:
          type: string
          description: The ID of the created document
          example: "abc123xyz"

    AuthDocRequest:
      type: object
      properties:
        authorization:
          type: string
          enum: [full, read-only]
          default: full
          description: Access level for the client token
        userId:
          type: string
          description: Optional user identifier
          example: "user-123"
        validForSeconds:
          type: integer
          default: 3600
          description: "Token validity duration in seconds (default: 1 hour)"
          example: 3600

    ClientToken:
      type: object
      required:
        - url
        - baseUrl
        - docId
        - authorization
      properties:
        url:
          type: string
          format: uri
          description: WebSocket URL for y-websocket provider
          example: "ws://localhost:8080/d/abc123/ws"
        baseUrl:
          type: string
          format: uri
          description: Base URL for document endpoints
          example: "http://localhost:8080/d/abc123"
        docId:
          type: string
          description: Document identifier
          example: "abc123"
        token:
          type: string
          description: JWT token (only present if authentication is configured)
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        authorization:
          type: string
          enum: [full, read-only]
          description: Authorization level granted to this token

    DocDeleteResponse:
      type: object
      required:
        - docId
        - dataDeleted
        - deletedAssets
        - success
      properties:
        docId:
          type: string
          description: ID of the deleted document
          example: "abc123"
        dataDeleted:
          type: boolean
          description: Whether the data.ysweet file was removed
          example: true
        deletedAssets:
          type: integer
          description: Number of asset objects removed
          example: 5
        success:
          type: boolean
          description: Overall operation success
          example: true

    DocCopyRequest:
      type: object
      required:
        - destinationDocId
      properties:
        destinationDocId:
          type: string
          description: The ID for the new copied document
          example: "new-doc-123"

    DocCopyResponse:
      type: object
      required:
        - sourceDocId
        - destinationDocId
        - success
      properties:
        sourceDocId:
          type: string
          description: ID of the source document
          example: "abc123"
        destinationDocId:
          type: string
          description: ID of the newly created document
          example: "new-doc-123"
        success:
          type: boolean
          description: Whether the copy operation succeeded
          example: true

    ContentUploadRequest:
      type: object
      required:
        - contentType
      properties:
        contentType:
          type: string
          pattern: "^(image|video)/"
          description: MIME type of the content to upload. Only image/* and video/* types are allowed.
          example: "image/png"

    ContentUploadResponse:
      type: object
      required:
        - uploadUrl
        - assetId
      properties:
        uploadUrl:
          type: string
          format: uri
          description: Presigned URL for uploading the asset
          example: "https://s3.amazonaws.com/bucket/path?signature=..."
        assetId:
          type: string
          description: Generated asset ID with file extension
          example: "clz1x2y3z4.png"

    Asset:
      type: object
      required:
        - assetId
        - downloadUrl
      properties:
        assetId:
          type: string
          description: Asset identifier (without extension)
          example: "clz1x2y3z4"
        downloadUrl:
          type: string
          format: uri
          description: Presigned URL for downloading the asset
          example: "https://s3.amazonaws.com/bucket/path?signature=..."

    AssetsResponse:
      type: object
      required:
        - assets
      properties:
        assets:
          type: array
          items:
            $ref: "#/components/schemas/Asset"
          description: List of assets associated with the document

paths:
  /ready:
    get:
      operationId: healthCheck
      summary: Health check
      description: |
        Returns 200 OK if the server is running and ready to accept requests.

        **Audience**: üîì Public API (no authentication required)
      tags:
        - Public API
        - Health
      responses:
        "200":
          description: Server is ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadyResponse"

  /check_store:
    post:
      operationId: checkStore
      summary: Validate store configuration
      description: |
        Checks that the document store is configured correctly.

        **Audience**: üîê Admin API (requires Server Token - backend only)
      tags:
        - Admin API
        - Health
      security:
        - ServerToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Store check result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckStoreResponse"
        "401":
          description: Unauthorized - invalid or missing server token

    get:
      operationId: checkStoreDeprecated
      summary: Validate store configuration (deprecated)
      description: |
        **DEPRECATED**: Use POST /check_store instead.

        Checks that the document store is configured correctly.

        **Audience**: üîê Admin API (requires Server Token - backend only)
      deprecated: true
      tags:
        - Admin API
        - Health
      security:
        - ServerToken: []
      responses:
        "200":
          description: Store check result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CheckStoreResponse"
        "401":
          description: Unauthorized - invalid or missing server token

  /doc/new:
    post:
      operationId: createDocument
      summary: Create a new document
      description: |
        Creates a new Yjs document. You can optionally provide a custom document ID,
        otherwise a random nanoid will be generated.

        **Audience**: üîê Admin API (requires Server Token - backend only)
      tags:
        - Admin API
        - Documents
      security:
        - ServerToken: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DocCreationRequest"
      responses:
        "200":
          description: Document created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NewDocResponse"
        "401":
          description: Unauthorized - invalid or missing server token
        "409":
          description: Conflict - document ID already exists

  /doc/{docId}/auth:
    post:
      operationId: authenticateDocument
      summary: Generate client token for document access
      description: |
        Generates a client authentication token for accessing a document.
        The token can be used to establish WebSocket connections and access document endpoints.

        **Audience**: üîê Admin API (requires Server Token - backend only)
      tags:
        - Admin API
        - Documents
      security:
        - ServerToken: []
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Document identifier
          example: "abc123"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthDocRequest"
      responses:
        "200":
          description: Client token generated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClientToken"
        "401":
          description: Unauthorized - invalid or missing server token

  /d/{docId}/as-update:
    get:
      operationId: getDocumentAsUpdate
      summary: Get document state as Yjs update
      description: |
        Returns the entire document state as a Yjs update binary.
        This can be used to initialize a Yjs document or sync the full state.

        **Audience**: üåê Client API (requires Doc Token - safe for browser)
      tags:
        - Client API
        - Documents
      security:
        - DocToken: []
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Document identifier
          example: "abc123"
      responses:
        "200":
          description: Document update data
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "401":
          description: Unauthorized - invalid or missing doc token
        "404":
          description: Document not found

  /doc/{docId}/as-update:
    get:
      operationId: getDocumentAsUpdateDeprecated
      summary: Get document state as Yjs update (deprecated)
      description: |
        **DEPRECATED**: Use `/d/:doc_id/as-update` instead.

        Returns the entire document state as a Yjs update binary.

        **Audience**: üåê Client API (requires Doc Token - safe for browser)
      deprecated: true
      tags:
        - Client API
        - Documents
      security:
        - DocToken: []
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Document identifier
          example: "abc123"
      responses:
        "200":
          description: Document update data
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "401":
          description: Unauthorized - invalid or missing doc token
        "404":
          description: Document not found

  /d/{docId}/update:
    post:
      operationId: updateDocument
      summary: Apply update to document
      description: |
        Applies a Yjs update to the document. The update must be a valid Yjs binary update.
        Requires full (read-write) authorization.

        **Audience**: üåê Client API (requires Doc Token - safe for browser)
      tags:
        - Client API
        - Documents
      security:
        - DocToken: []
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Document identifier
          example: "abc123"
      requestBody:
        required: true
        description: Yjs update binary data
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        "200":
          description: Update applied successfully
        "401":
          description: Unauthorized - invalid or missing doc token, or read-only access
        "404":
          description: Document not found

  /doc/{docId}/update:
    post:
      operationId: updateDocumentDeprecated
      summary: Apply update to document (deprecated)
      description: |
        **DEPRECATED**: Use `/d/:doc_id/update` instead.

        Applies a Yjs update to the document.

        **Audience**: üåê Client API (requires Doc Token - safe for browser)
      deprecated: true
      tags:
        - Client API
        - Documents
      security:
        - DocToken: []
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Document identifier
          example: "abc123"
      requestBody:
        required: true
        description: Yjs update binary data
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        "200":
          description: Update applied successfully
        "401":
          description: Unauthorized - invalid or missing doc token, or read-only access
        "404":
          description: Document not found

  /d/{docId}/ws/{docId2}:
    get:
      operationId: websocketConnection
      summary: WebSocket connection for real-time sync
      description: |
        Establishes a WebSocket connection for real-time document synchronization.
        Uses the y-websocket protocol for Yjs document sync.

        **Note**: Both `docId` and `docId2` path parameters must be identical.
        This is required for compatibility with the Yjs y-websocket provider.

        **Audience**: üåê Client API (requires Doc Token - safe for browser)
      tags:
        - Client API
        - WebSocket
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Document identifier
          example: "abc123"
        - name: docId2
          in: path
          required: true
          schema:
            type: string
          description: Document identifier (must match docId)
          example: "abc123"
        - name: token
          in: query
          required: false
          schema:
            type: string
          description: Optional document authentication token
      responses:
        "101":
          description: Switching Protocols - WebSocket connection established
        "401":
          description: Unauthorized - invalid or missing authentication
        "404":
          description: Document not found

  /doc/ws/{docId}:
    get:
      operationId: websocketConnectionDeprecated
      summary: WebSocket connection (deprecated)
      description: |
        **DEPRECATED**: Use `/doc/:doc_id/auth` to get the proper WebSocket URL.

        Establishes a WebSocket connection for real-time document synchronization.

        **Audience**: üåê Client API (requires Doc Token - safe for browser)
      deprecated: true
      tags:
        - Client API
        - WebSocket
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Document identifier
          example: "abc123"
        - name: token
          in: query
          required: false
          schema:
            type: string
          description: Optional document authentication token
      responses:
        "101":
          description: Switching Protocols - WebSocket connection established
        "401":
          description: Unauthorized - invalid or missing authentication
        "404":
          description: Document not found

  /d/{docId}:
    delete:
      operationId: deleteDocument
      summary: Delete document
      description: |
        Deletes a document and all its associated assets.
        This operation is irreversible.

        **Extension**: This is a custom endpoint (not part of upstream y-sweet).

        **Audience**: üîê Admin API (requires Server Token - backend only)
      tags:
        - Admin API
        - Documents
      security:
        - ServerToken: []
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Document identifier
          example: "abc123"
      responses:
        "200":
          description: Document deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DocDeleteResponse"
        "401":
          description: Unauthorized - invalid or missing server token
        "404":
          description: Document not found

  /d/{docId}/copy:
    post:
      operationId: copyDocument
      summary: Copy document
      description: |
        Creates a copy of a document with a new document ID.
        All assets are also copied to the new document.
        The document is force-synced before copying to ensure data integrity.

        **Extension**: This is a custom endpoint (not part of upstream y-sweet).

        **Audience**: üîê Admin API (requires Server Token - backend only)
      tags:
        - Admin API
        - Documents
      security:
        - ServerToken: []
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Source document identifier
          example: "abc123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DocCopyRequest"
      responses:
        "200":
          description: Document copied successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DocCopyResponse"
        "401":
          description: Unauthorized - invalid or missing server token
        "404":
          description: Source document not found
        "409":
          description: Destination document ID already exists

  /d/{docId}/assets:
    post:
      operationId: generateUploadUrl
      summary: Generate presigned upload URL
      description: |
        Generates a presigned S3 URL for uploading an asset (image or video).
        The URL is valid for a limited time (typically 15 minutes).

        **Extension**: This is a custom endpoint (not part of upstream y-sweet).

        **Allowed content types**: Only `image/*` and `video/*` MIME types are permitted.

        **Audience**: üåê Client API (requires Doc Token - safe for browser)
      tags:
        - Client API
        - Assets
      security:
        - DocToken: []
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Document identifier
          example: "abc123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ContentUploadRequest"
      responses:
        "200":
          description: Presigned upload URL generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ContentUploadResponse"
        "400":
          description: Invalid content type (not image/* or video/*)
        "401":
          description: Unauthorized - invalid or missing doc token

    get:
      operationId: listAssets
      summary: List document assets
      description: |
        Returns a list of all assets associated with the document,
        including presigned download URLs for each asset.

        **Extension**: This is a custom endpoint (not part of upstream y-sweet).

        The response includes a `Cache-Control` header with `private, max-age=30`
        to allow short-term caching of presigned URLs.

        **Audience**: üåê Client API (requires Doc Token - safe for browser)
      tags:
        - Client API
        - Assets
      security:
        - DocToken: []
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Document identifier
          example: "abc123"
      responses:
        "200":
          description: List of assets
          headers:
            Cache-Control:
              schema:
                type: string
                example: "private, max-age=30"
              description: Caching directive for presigned URLs
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AssetsResponse"
        "401":
          description: Unauthorized - invalid or missing doc token

  # Single Document Mode Endpoints
  /ws/{docId}:
    get:
      operationId: websocketConnectionSingleDoc
      summary: WebSocket connection (single-doc mode)
      description: |
        WebSocket endpoint for single-document mode.
        Uses Plane authentication headers instead of bearer tokens.

        **Note**: This endpoint is only available when running in single-document mode.

        **Audience**: üåê Client API (Plane auth - safe for browser)
      tags:
        - Client API
        - Single Document Mode
      parameters:
        - name: docId
          in: path
          required: true
          schema:
            type: string
          description: Document identifier
          example: "abc123"
        - name: x-verified-user-data
          in: header
          required: true
          schema:
            type: string
            example: '{"authorization": "full"}'
          description: Plane verified user data header containing authorization level
      responses:
        "101":
          description: Switching Protocols - WebSocket connection established
        "401":
          description: Unauthorized - invalid or missing authentication
        "404":
          description: Document not found

  /as-update:
    get:
      operationId: getDocumentAsUpdateSingleDoc
      summary: Get document state (single-doc mode)
      description: |
        Returns the document state as a Yjs update binary in single-document mode.

        **Note**: This endpoint is only available when running in single-document mode.

        **Audience**: üåê Client API (Plane auth - safe for browser)
      tags:
        - Client API
        - Single Document Mode
      responses:
        "200":
          description: Document update data
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "401":
          description: Unauthorized
        "404":
          description: Document not found

  /update:
    post:
      operationId: updateDocumentSingleDoc
      summary: Apply update to document (single-doc mode)
      description: |
        Applies a Yjs update to the document in single-document mode.
        Uses Plane authentication headers.

        **Note**: This endpoint is only available when running in single-document mode.

        **Audience**: üåê Client API (Plane auth - safe for browser)
      tags:
        - Client API
        - Single Document Mode
      parameters:
        - name: x-verified-user-data
          in: header
          required: true
          schema:
            type: string
            example: '{"authorization": "full"}'
          description: Plane verified user data header (must have "full" authorization)
      requestBody:
        required: true
        description: Yjs update binary data
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        "200":
          description: Update applied successfully
        "401":
          description: Unauthorized - invalid auth or read-only access
        "404":
          description: Document not found

  /assets:
    post:
      operationId: generateUploadUrlSingleDoc
      summary: Generate presigned upload URL (single-doc mode)
      description: |
        Generates a presigned S3 URL for uploading an asset in single-document mode.

        **Note**: This endpoint is only available when running in single-document mode.

        **Audience**: üåê Client API (Plane auth - safe for browser)
      tags:
        - Client API
        - Single Document Mode
      parameters:
        - name: x-verified-user-data
          in: header
          required: true
          schema:
            type: string
            example: '{"authorization": "full"}'
          description: Plane verified user data header
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ContentUploadRequest"
      responses:
        "200":
          description: Presigned upload URL generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ContentUploadResponse"
        "400":
          description: Invalid content type
        "401":
          description: Unauthorized

    get:
      operationId: listAssetsSingleDoc
      summary: List document assets (single-doc mode)
      description: |
        Returns a list of all assets for the document in single-document mode.

        **Note**: This endpoint is only available when running in single-document mode.

        **Audience**: üåê Client API (Plane auth - safe for browser)
      tags:
        - Client API
        - Single Document Mode
      parameters:
        - name: x-verified-user-data
          in: header
          required: true
          schema:
            type: string
            example: '{"authorization": "full"}'
          description: Plane verified user data header
      responses:
        "200":
          description: List of assets
          headers:
            Cache-Control:
              schema:
                type: string
                example: "private, max-age=30"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AssetsResponse"
        "401":
          description: Unauthorized
